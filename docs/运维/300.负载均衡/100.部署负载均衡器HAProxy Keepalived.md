---
title: 部署负载均衡器HAProxy Keepalived
date: 2020-06-24 11:22:24
permalink: /loadbalance-haproxy-keepalived.html
categories:
  - 运维
  - 负载均衡
tags:
  -
---

# 部署负载均衡器 HAProxy Keepalived

## 准备环境

CentOS-6.5-x86_64-minimal

## 约定

HAProxy_Master: 10.96.34.170
HAProxy_Backup: 10.96.34.172
mediaServer1: 10.96.34.173
mediaServer2: 10.96.34.174
VIP：10.96.34.200

## 安装 mediaServer

安装媒体服务器 mediaServer1、mediaServer2。

## 安装 HAProxy_Master

1. 安装负载均衡(即 HAProxy)  
   1> 安装  
   setenforce 0  
   service iptables stop  
   yum install -y haproxy  
   vi /etc/haproxy/haproxy.cfg:  
   ![20200624113010.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624113010.png)  
   service haproxy start  
   2> 验证  
   通过请求 10.96.34.170:80、10.96.34.170:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。
2. 安装高可用热备软件（即 keepalived）  
   yum install -y keepalived  
    vi /etc/keepalived/keepalived.conf:  
   ![20200624113127.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624113127.png)  
   mkdir /usr/local/keepalived/  
   vi /usr/local/keepalived/check_haproxy.sh：//配置监控脚本，功能：当 HAProxy 服务停止，自动重启

```
#!/bin/bash
if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
/etc/init.d/haproxy start
fi
sleep 2
if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
/etc/init.d/keepalived stop
fi
```

chmod +x /usr/local/keepalived/check_haproxy.sh  
service keepalived start  
验证监控脚本：停止 haproxy 服务，发现会自动重启。  
ip addr show eth0  
![20200624114400.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114400.png)

## 安装 HAProxy_Backup

1. 安装负载均衡(即 HAProxy)  
   1> 安装  
   同"安装 HAProxy_Master"的对应部分。  
   2> 验证  
   通过请求 10.96.34.172:80、10.96.34.172:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。
2. 安装高可用热备软件（即 keepalived）  
   yum install -y keepalived  
    vi /etc/keepalived/keepalived.conf:
   ![20200624114636.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114636.png)  
   mkdir /usr/local/keepalived/  
   vi /usr/local/keepalived/check_haproxy.sh：//配置监控脚本，功能：当 HAProxy 服务停止，自动重启

```
#!/bin/bash
if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
/etc/init.d/haproxy start
fi
sleep 2
if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then
/etc/init.d/keepalived stop
fi
```

chmod +x /usr/local/keepalived/check_haproxy.sh  
service keepalived start  
验证监控脚本：停止 haproxy 服务，发现会自动重启。  
ip addr show eth0  
![20200624114925.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114925.png)

## 安装验证

1. 验证轮询  
   通过请求 10.96.34.200:80、10.96.34.200:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。  
   结论：轮询机制验证通过。
2. 验证高可用性  
    在 HAProxy_Master 或 HAProxy_Backup 任意一台服务器上执行：service keepalived stop 或 service haproxy stop。 10.96.34.200:80、10.96.34.200:1935 仍能正常提供业务。  
    结论：HAProxy_Master、HAProxy_Backup 任意一台机器宕机不影响整个业务，高可用机制验证通过。  
    附：在 HAProxy_Master 上执行 service keepalived stop，则 VIP 绑定到 HAProxy_Backup。  
    HAProxy_Master 上操作如下：  
    ![20200624115317.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624115317.png)  
    HAProxy_Backup 上操作如下：  
   ![20200624115400.png](https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624115400.png)
   > [配置讲解](http://cbonte.github.io/haproxy-dconv/configuration-1.4.html)
