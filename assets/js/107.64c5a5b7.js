(window.webpackJsonp=window.webpackJsonp||[]).push([[107],{603:function(e,r,a){"use strict";a.r(r);var t=a(26),i=Object(t.a)({},(function(){var e=this,r=e.$createElement,a=e._self._c||r;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"部署负载均衡器-haproxy-keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署负载均衡器-haproxy-keepalived"}},[e._v("#")]),e._v(" 部署负载均衡器 HAProxy Keepalived")]),e._v(" "),a("h2",{attrs:{id:"准备环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备环境"}},[e._v("#")]),e._v(" 准备环境")]),e._v(" "),a("p",[e._v("CentOS-6.5-x86_64-minimal")]),e._v(" "),a("h2",{attrs:{id:"约定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#约定"}},[e._v("#")]),e._v(" 约定")]),e._v(" "),a("p",[e._v("HAProxy_Master: 10.96.34.170\nHAProxy_Backup: 10.96.34.172\nmediaServer1: 10.96.34.173\nmediaServer2: 10.96.34.174\nVIP：10.96.34.200")]),e._v(" "),a("h2",{attrs:{id:"安装-mediaserver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-mediaserver"}},[e._v("#")]),e._v(" 安装 mediaServer")]),e._v(" "),a("p",[e._v("安装媒体服务器 mediaServer1、mediaServer2。")]),e._v(" "),a("h2",{attrs:{id:"安装-haproxy-master"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-haproxy-master"}},[e._v("#")]),e._v(" 安装 HAProxy_Master")]),e._v(" "),a("ol",[a("li",[e._v("安装负载均衡(即 HAProxy)"),a("br"),e._v("\n1> 安装"),a("br"),e._v("\nsetenforce 0"),a("br"),e._v("\nservice iptables stop"),a("br"),e._v("\nyum install -y haproxy"),a("br"),e._v("\nvi /etc/haproxy/haproxy.cfg:"),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624113010.png",alt:"20200624113010.png"}}),a("br"),e._v("\nservice haproxy start"),a("br"),e._v("\n2> 验证"),a("br"),e._v("\n通过请求 10.96.34.170:80、10.96.34.170:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。")]),e._v(" "),a("li",[e._v("安装高可用热备软件（即 keepalived）"),a("br"),e._v("\nyum install -y keepalived"),a("br"),e._v("\nvi /etc/keepalived/keepalived.conf:"),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624113127.png",alt:"20200624113127.png"}}),a("br"),e._v("\nmkdir /usr/local/keepalived/"),a("br"),e._v("\nvi /usr/local/keepalived/check_haproxy.sh：//配置监控脚本，功能：当 HAProxy 服务停止，自动重启")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#!/bin/bash\nif [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then\n/etc/init.d/haproxy start\nfi\nsleep 2\nif [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then\n/etc/init.d/keepalived stop\nfi\n")])])]),a("p",[e._v("chmod +x /usr/local/keepalived/check_haproxy.sh"),a("br"),e._v("\nservice keepalived start"),a("br"),e._v("\n验证监控脚本：停止 haproxy 服务，发现会自动重启。"),a("br"),e._v("\nip addr show eth0"),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114400.png",alt:"20200624114400.png"}})]),e._v(" "),a("h2",{attrs:{id:"安装-haproxy-backup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-haproxy-backup"}},[e._v("#")]),e._v(" 安装 HAProxy_Backup")]),e._v(" "),a("ol",[a("li",[e._v("安装负载均衡(即 HAProxy)"),a("br"),e._v("\n1> 安装"),a("br"),e._v('\n同"安装 HAProxy_Master"的对应部分。'),a("br"),e._v("\n2> 验证"),a("br"),e._v("\n通过请求 10.96.34.172:80、10.96.34.172:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。")]),e._v(" "),a("li",[e._v("安装高可用热备软件（即 keepalived）"),a("br"),e._v("\nyum install -y keepalived"),a("br"),e._v("\nvi /etc/keepalived/keepalived.conf:\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114636.png",alt:"20200624114636.png"}}),a("br"),e._v("\nmkdir /usr/local/keepalived/"),a("br"),e._v("\nvi /usr/local/keepalived/check_haproxy.sh：//配置监控脚本，功能：当 HAProxy 服务停止，自动重启")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#!/bin/bash\nif [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then\n/etc/init.d/haproxy start\nfi\nsleep 2\nif [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then\n/etc/init.d/keepalived stop\nfi\n")])])]),a("p",[e._v("chmod +x /usr/local/keepalived/check_haproxy.sh"),a("br"),e._v("\nservice keepalived start"),a("br"),e._v("\n验证监控脚本：停止 haproxy 服务，发现会自动重启。"),a("br"),e._v("\nip addr show eth0"),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624114925.png",alt:"20200624114925.png"}})]),e._v(" "),a("h2",{attrs:{id:"安装验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装验证"}},[e._v("#")]),e._v(" 安装验证")]),e._v(" "),a("ol",[a("li",[e._v("验证轮询"),a("br"),e._v("\n通过请求 10.96.34.200:80、10.96.34.200:1935 可知：mediaServer1、mediaServer2 任意一个宕机不影响整个业务，宕机恢复后，HAProxy 继续轮询。"),a("br"),e._v("\n结论：轮询机制验证通过。")]),e._v(" "),a("li",[e._v("验证高可用性"),a("br"),e._v("\n在 HAProxy_Master 或 HAProxy_Backup 任意一台服务器上执行：service keepalived stop 或 service haproxy stop。 10.96.34.200:80、10.96.34.200:1935 仍能正常提供业务。"),a("br"),e._v("\n结论：HAProxy_Master、HAProxy_Backup 任意一台机器宕机不影响整个业务，高可用机制验证通过。"),a("br"),e._v("\n附：在 HAProxy_Master 上执行 service keepalived stop，则 VIP 绑定到 HAProxy_Backup。"),a("br"),e._v("\nHAProxy_Master 上操作如下："),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624115317.png",alt:"20200624115317.png"}}),a("br"),e._v("\nHAProxy_Backup 上操作如下："),a("br"),e._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/wangshibiaoFlytiger/blog_picBed1/images/20200624115400.png",alt:"20200624115400.png"}}),e._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"http://cbonte.github.io/haproxy-dconv/configuration-1.4.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("配置讲解"),a("OutboundLink")],1)])])])])])}),[],!1,null,null,null);r.default=i.exports}}]);